# Sandbox Environment API

A FastAPI-based sandbox environment for evaluating aptitude questions and coding challenges using Docker containers. Questions are pre-generated by the `qa_gen_spice` service and stored in MongoDB, organized by **job ID**.

## Features

### ğŸ¯ Two Modes of Operation

#### 1. Aptitude Mode
- Fetch pre-generated aptitude questions from database
- Filter by job ID, difficulty, and topic
- Submit and evaluate answers
- Get detailed feedback and learning points
- Track wrong answers and improvement areas

#### 2. Code Mode
- Fetch pre-generated coding challenges from database
- Filter by job ID, difficulty, and topic
- Execute code in isolated Docker containers
- Run code against test cases
- Get AI-powered code review and feedback
- Secure sandbox with resource limits (CPU, Memory, TTL)

### ğŸ­ Job ID-Based Filtering
- Questions organized by job ID (linked to specific job postings)
- Fetch job-specific questions for targeted assessments
- View statistics per job ID
- List all available job IDs

### ğŸ”’ Security Features
- Docker container isolation for code execution
- No network access for code containers
- Resource limits (256MB RAM, 0.5 CPU)
- Container TTL (Time To Live) management
- Automatic cleanup of expired containers

### ğŸ“Š Learning Analytics
- Store summaries of incorrect attempts
- Track topics where users struggle
- AI-generated explanations for wrong answers
- Personalized learning points

### ğŸ”— Integration with qa_gen_spice
- Questions are generated by the `qa_gen_spice` service
- Stored in MongoDB (`qa_gen_db.dsa_questions`)
- code-sandbox fetches questions on demand
- Separate collections for code and aptitude questions

## Architecture

```
qa_gen_spice â†’ MongoDB (qa_gen_db) â†’ code-sandbox
  (Generate)     (dsa_questions)      (Fetch & Execute)

â”œâ”€â”€ main.py                 # FastAPI application entry point
â”œâ”€â”€ config.py              # Configuration settings
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ database.py       # MongoDB connection
â”‚   â””â”€â”€ schemas.py        # Pydantic models
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ question_service.py    # NEW: Question fetching from DB
â”‚   â”œâ”€â”€ openrouter_service.py  # LLM integration
â”‚   â””â”€â”€ docker_sandbox.py      # Docker code execution
â””â”€â”€ routes/
    â”œâ”€â”€ aptitude.py       # Aptitude mode endpoints
    â””â”€â”€ code.py           # Code mode endpoints
```

## Setup

### Prerequisites
- Python 3.11+
- Docker Desktop (for Windows)
- MongoDB Atlas account (or local MongoDB)
- OpenRouter API key

### Installation

1. **Clone the repository**
```bash
cd c:\Users\Bhushan\Desktop\Zenith\code-sandbox
```

2. **Create virtual environment**
```powershell
python -m venv venv
.\venv\Scripts\Activate.ps1
```

3. **Install dependencies**
```powershell
pip install -r requirements.txt
```

4. **Configure environment variables**
```powershell
# Copy example env file
Copy-Item .env.example .env

# Edit .env and add your OpenRouter API key
notepad .env
```

Required environment variables:
- `OPENROUTER_API_KEY`: Your OpenRouter API key
- `MONGODB_URL`: MongoDB connection string (already configured)

5. **Start Docker Desktop**
Make sure Docker Desktop is running on your Windows machine.

6. **Run the application**
```powershell
python main.py
```

The API will be available at: `http://localhost:8000`

## Using Docker Compose

For production deployment:

```powershell
# Build and start
docker-compose up --build

# Run in background
docker-compose up -d

# View logs
docker-compose logs -f

# Stop
docker-compose down
```

## API Documentation

Once the server is running, access:
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

## API Endpoints

### Question Statistics

#### Get Available Questions
```http
GET /api/v1/questions/stats
GET /api/v1/questions/stats?job_id=60d5ec49f1a2c8b1f8e4e1a1
```

Returns statistics about available questions in the database, optionally filtered by job ID.

**Response:**
```json
{
  "total_questions": 150,
  "job_id": "60d5ec49f1a2c8b1f8e4e1a1",
  "code_questions": {
    "total": 100,
    "easy": 40,
    "medium": 35,
    "hard": 25
  },
  "aptitude_questions": {
    "total": 50,
    "easy": 20,
    "medium": 18,
    "hard": 12
  }
}
```

#### Get Available Job IDs
```http
GET /api/v1/questions/job-ids
```

Returns list of all job IDs that have questions.

**Response:**
```json
{
  "total_job_ids": 3,
  "job_ids": [
    {
      "job_id": "60d5ec49f1a2c8b1f8e4e1a1",
      "total_questions": 45,
      "code_questions": 30,
      "aptitude_questions": 15
    },
    {
      "job_id": "60d5ec49f1a2c8b1f8e4e1a2",
      "total_questions": 35,
      "code_questions": 25,
      "aptitude_questions": 10
    }
  ]
}
```

### Aptitude Mode

#### Get Question (Fetch from Database)
```http
POST /api/v1/aptitude/get-question
Content-Type: application/json

{
  "mode": "apti",
  "difficulty": "medium",
  "topic": "logical",
  "job_id": "60d5ec49f1a2c8b1f8e4e1a1",
  "user_id": "user123"
}
```

**Response:**
```json
{
  "question_id": "507f1f77bcf86cd799439011",
  "question_text": "If all Bloops are Razzies...",
  "options": ["A) True", "B) False", "C) Cannot say"],
  "difficulty": "medium",
  "topic": "logical"
}
```

> **Note:** `job_id`, `difficulty`, and `topic` are all optional filters.

#### Submit Answer
```http
POST /api/v1/aptitude/submit-answer
Content-Type: application/json

{
  "user_id": "user123",
  "question_id": "507f1f77bcf86cd799439011",
  "user_answer": "A"
}
```

#### Get User Summary
```http
GET /api/v1/aptitude/user-summary/{user_id}
```

### Code Mode

#### Get Question (Fetch from Database)
```http
POST /api/v1/code/get-question
Content-Type: application/json

{
  "mode": "code",
  "difficulty": "medium",
  "topic": "arrays",
  "job_id": "60d5ec49f1a2c8b1f8e4e1a1",
  "user_id": "user123"
}
```

**Response:**
```json
{
  "question_id": "507f1f77bcf86cd799439012",
  "title": "Two Sum",
  "description": "Given an array of integers...",
  "difficulty": "medium",
  "topic": "arrays",
  "starter_code": "# Write your code here\n",
  "test_cases_count": 5,
  "visible_test_cases": [
    {
      "input": "[2,7,11,15], target=9",
      "expected_output": "[0,1]"
    }
  ],
  "constraints": ["1 <= n <= 1000"],
  "hints": ["Use a hash map"]
}
```

> **Note:** `job_id`, `difficulty`, and `topic` are all optional filters.

#### Submit Code
```http
POST /api/v1/code/submit-code
Content-Type: application/json

{
  "user_id": "user123",
  "question_id": "507f1f77bcf86cd799439012",
  "code": "def solution(arr, target):\n    seen = {}\n    for i, num in enumerate(arr):\n        if target - num in seen:\n            return [seen[target - num], i]\n        seen[num] = i",
  "language": "python"
}
```

#### Run Code (Test)
```http
POST /api/v1/code/run-code
Content-Type: application/json

{
  "user_id": "user123",
  "question_id": "test",
  "code": "print('Hello, World!')",
  "language": "python"
}
```

#### Get User Summary
```http
GET /api/v1/code/user-summary/{user_id}
```

## Database Collections

The system uses the following MongoDB database and collections:

### Database: `qa_gen_db` (Shared with qa_gen_spice)

- `dsa_questions`: Pre-generated questions (code and aptitude) from qa_gen_spice
  - Questions have `question_type` field: "code" or "apti"
  - Contains test cases, constraints, hints for code questions
  - Contains options, correct answers for aptitude questions

### Database: `qa_gen_db` (code-sandbox specific)

- `aptitude_submissions`: User aptitude submissions
- `code_submissions`: User code submissions
- `user_attempt_summaries`: Summary of wrong answers with learning points

## Prerequisites & Setup Workflow

### âš ï¸ Important: Question Generation First

Before using code-sandbox, you need to generate questions using the `qa_gen_spice` service:

1. **Generate Questions** (in qa_gen_spice service)
   ```bash
   cd qa_gen_spice
   python question_generator.py --count 50 --type code --difficulty medium
   python question_generator.py --count 30 --type apti --difficulty easy
   ```

2. **Verify Question Availability** (in code-sandbox)
   ```bash
   curl http://localhost:8000/api/v1/questions/stats
   ```

3. **Use code-sandbox** to fetch and execute questions

### Integration Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  qa_gen_spice   â”‚ Step 1: Generate questions
â”‚  (Generate)     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   MongoDB   â”‚ Step 2: Store in DB
                    â”‚  qa_gen_db  â”‚
                    â”‚             â”‚
                    â”‚ dsa_questions â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ Step 3: Fetch questions
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  code-sandbox   â”‚ Step 4: Execute & Evaluate
                  â”‚  (Fetch & Run)  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Configuration

Edit `config.py` or use environment variables:

| Variable | Default | Description |
|----------|---------|-------------|
| `DOCKER_TIMEOUT` | 30 | Code execution timeout (seconds) |
| `DOCKER_MEMORY_LIMIT` | 256m | Memory limit per container |
| `DOCKER_CPU_QUOTA` | 50000 | CPU quota (0.5 CPU) |
| `CONTAINER_TTL` | 300 | Container time-to-live (seconds) |
| `OPENROUTER_MODEL` | claude-3.5-sonnet | LLM model to use |

## How It Works

### Aptitude Mode Flow
1. User requests a question â†’ code-sandbox fetches from database (pre-generated by qa_gen_spice)
2. User receives question (without correct answer)
3. User submits answer â†’ LLM evaluates the answer
4. If wrong, detailed explanation and learning points stored in database

### Code Mode Flow
1. User requests a coding challenge â†’ code-sandbox fetches from database (pre-generated by qa_gen_spice)
2. User receives challenge with visible test cases
3. User writes code and submits
4. Code executed in isolated Docker container with all test cases (including hidden ones)
5. Results evaluated by LLM for code quality and correctness
6. If wrong, detailed feedback and suggestions stored in database

### Docker Sandbox Security
- Containers run with no network access
- Resource limits prevent resource exhaustion
- Automatic cleanup after TTL expires
- Background task cleans up orphaned containers

## Development

### Project Structure
```
code-sandbox/
â”œâ”€â”€ main.py                 # Application entry
â”œâ”€â”€ config.py              # Configuration
â”œâ”€â”€ requirements.txt       # Python dependencies
â”œâ”€â”€ Dockerfile            # Container definition
â”œâ”€â”€ docker-compose.yml    # Orchestration
â”œâ”€â”€ .env.example          # Environment template
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ database.py       # MongoDB setup
â”‚   â””â”€â”€ schemas.py        # Data models
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ openrouter_service.py  # LLM integration
â”‚   â””â”€â”€ docker_sandbox.py      # Code execution
â””â”€â”€ routes/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ aptitude.py       # Aptitude endpoints
    â””â”€â”€ code.py           # Code endpoints
```

### Running Tests

```powershell
# Install test dependencies
pip install pytest pytest-asyncio httpx

# Run tests (if you create them)
pytest
```

## Troubleshooting

### No Questions Available

**Error:**
```json
{
  "status_code": 404,
  "detail": "No questions available matching the criteria. Please generate questions using qa_gen_spice service first."
}
```

**Solution:**
1. First, check available questions:
   ```bash
   curl http://localhost:8000/api/v1/questions/stats
   ```

2. If no questions exist, generate them using qa_gen_spice:
   ```bash
   cd ../qa_gen_spice
   python question_generator.py --count 50 --type code
   python question_generator.py --count 30 --type apti
   ```

3. Retry fetching questions

### Docker Connection Issues
- Ensure Docker Desktop is running
- Check if Docker socket is accessible: `docker ps`

### MongoDB Connection Issues
- Verify MongoDB URL in `.env`
- Check network connectivity
- Ensure database user has correct permissions
- **Important**: Make sure you're connecting to `qa_gen_db` database

### Database Connection Issues
If code-sandbox can't find questions:
1. Verify both services connect to the same MongoDB
2. Check database name is `qa_gen_db` in config.py
3. Verify questions exist in `dsa_questions` collection:
   ```python
   from pymongo import MongoClient
   client = MongoClient("your-mongodb-url")
   db = client["qa_gen_db"]
   print(db.dsa_questions.count_documents({"question_type": "code"}))
   print(db.dsa_questions.count_documents({"question_type": "apti"}))
   ```

### OpenRouter API Issues
- Verify API key is correct
- Check API quota/limits
- Review OpenRouter service status

## Security Considerations

For production deployment:
1. Use environment variables for all secrets
2. Configure CORS appropriately
3. Add authentication/authorization
4. Set up rate limiting
5. Use HTTPS
6. Monitor container resource usage
7. Implement logging and monitoring

## Future Enhancements

- [ ] Support for multiple programming languages (Java, JavaScript, C++, etc.)
- [ ] Real-time code execution feedback
- [ ] User authentication and authorization
- [ ] Rate limiting per user
- [ ] Question history tracking (avoid repeating questions)
- [ ] WebSocket support for live execution
- [ ] Admin dashboard for question management
- [ ] Adaptive difficulty based on user performance
- [ ] Question feedback and rating system
- [ ] Bulk question generation trigger via API

## Related Services

- **qa_gen_spice**: Question generation service (must run first)
- **JD_Parser**: Job description parsing (for job-relevant questions)
- **llm-council**: Candidate evaluation service

## Documentation

- [QA Gen Integration Guide](QA_GEN_INTEGRATION.md) - Detailed integration documentation
- [Job ID Filtering Guide](JOB_ID_FILTERING.md) - Job ID-based question filtering
- [API Documentation](http://localhost:8000/docs) - Interactive API docs (when server is running)

## License

MIT License

## Support

For issues and questions, please open an issue in the repository.
