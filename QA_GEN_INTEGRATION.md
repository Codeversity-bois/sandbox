# QA Gen Spice Integration

## Overview

The code-sandbox service is now integrated with the `qa_gen_spice` service for question management. Questions are pre-generated by qa_gen_spice and stored in MongoDB, then code-sandbox retrieves them when needed.

## Architecture

```
┌─────────────────────┐
│   qa_gen_spice      │
│  (Question Gen)     │
│                     │
│  - Generates Qs     │
│  - Stores in DB     │
└──────────┬──────────┘
           │
           │ Writes to
           ▼
    ┌─────────────┐
    │   MongoDB   │
    │  qa_gen_db  │
    │             │
    │ dsa_questions │
    └──────┬──────┘
           │
           │ Reads from
           ▼
┌─────────────────────┐
│   code-sandbox      │
│  (Question Fetch)   │
│                     │
│  - Fetches Qs       │
│  - Executes Code    │
│  - Evaluates        │
└─────────────────────┘
```

## Database Schema

### Collection: `dsa_questions`
Questions are stored with the following structure:

```json
{
  "_id": "ObjectId",
  "question_type": "code" | "apti",
  "title": "Question Title",
  "description": "Detailed description",
  "difficulty": "easy" | "medium" | "hard",
  "topics": ["arrays", "dynamic-programming"],
  
  // For CODE questions
  "test_cases": [
    {
      "input": "test input",
      "expected_output": "expected output",
      "is_hidden": false
    }
  ],
  "constraints": ["1 <= n <= 1000"],
  "hints": ["Consider using a hash map"],
  "time_complexity_expected": "O(n)",
  "space_complexity_expected": "O(1)",
  
  // For APTITUDE questions
  "options": ["Option A", "Option B", "Option C", "Option D"],
  "correct_answer": "Option B",
  "explanation": "Detailed explanation of the answer",
  
  "created_at": "2026-02-07T10:00:00Z",
  "job_id": "optional-job-reference"
}
```

## API Changes

### Code Mode

#### Old Endpoint (Deprecated)
```
POST /api/v1/code/generate-question
```
- Generated questions on-the-fly
- Stored in `sandbox_db.code_questions`

#### New Endpoint
```
POST /api/v1/code/get-question
```
- Fetches pre-generated questions from `qa_gen_db.dsa_questions`
- Filters by `question_type="code"`
- Returns random question matching criteria

**Request:**
```json
{
  "mode": "code",
  "user_id": "user123",
  "difficulty": "medium",
  "topic": "arrays"
}
```

**Response:**
```json
{
  "question_id": "507f1f77bcf86cd799439011",
  "title": "Two Sum",
  "description": "Given an array of integers...",
  "difficulty": "medium",
  "topic": "arrays",
  "starter_code": "# Write your code here\n",
  "test_cases_count": 5,
  "visible_test_cases": [
    {
      "input": "[2,7,11,15], target=9",
      "expected_output": "[0,1]",
      "is_hidden": false
    }
  ],
  "constraints": ["1 <= n <= 1000"],
  "hints": ["Use a hash map for O(n) solution"]
}
```

### Aptitude Mode

#### Old Endpoint (Deprecated)
```
POST /api/v1/aptitude/generate-question
```
- Generated questions on-the-fly
- Stored in `sandbox_db.aptitude_questions`

#### New Endpoint
```
POST /api/v1/aptitude/get-question
```
- Fetches pre-generated questions from `qa_gen_db.dsa_questions`
- Filters by `question_type="apti"`
- Returns random question matching criteria

**Request:**
```json
{
  "mode": "apti",
  "user_id": "user123",
  "difficulty": "easy",
  "topic": "logical"
}
```

**Response:**
```json
{
  "question_id": "507f1f77bcf86cd799439011",
  "question_text": "If all Bloops are Razzies...",
  "options": ["A) True", "B) False", "C) Cannot say"],
  "difficulty": "easy",
  "topic": "logical"
}
```

### New Endpoints

#### Question Statistics
```
GET /api/v1/questions/stats
```

Returns statistics about available questions in the database.

**Response:**
```json
{
  "total_questions": 150,
  "code_questions": {
    "total": 100,
    "easy": 40,
    "medium": 35,
    "hard": 25
  },
  "aptitude_questions": {
    "total": 50,
    "easy": 20,
    "medium": 18,
    "hard": 12
  }
}
```

## Configuration Changes

### Updated Config (`config.py`)

```python
class Settings(BaseSettings):
    # MongoDB Configuration
    DATABASE_NAME: str = "qa_gen_db"  # Changed from "sandbox_db"
    QUESTIONS_COLLECTION: str = "dsa_questions"  # New collection reference
```

## Services

### Question Service (`services/question_service.py`)

New service for fetching questions from the database.

**Key Methods:**
- `fetch_question(question_type, difficulty, topic)` - Get random question
- `get_question_by_id(question_id)` - Get specific question
- `list_questions(filters)` - List questions with filters
- `get_question_count(filters)` - Count questions matching criteria

## Workflow

### 1. Question Generation (qa_gen_spice)
```bash
# Run qa_gen_spice to generate questions
cd qa_gen_spice
python question_generator.py --count 50 --type code --difficulty medium
python question_generator.py --count 30 --type apti --difficulty easy
```

### 2. Question Retrieval (code-sandbox)
```bash
# Start code-sandbox
cd code-sandbox
python main.py

# Questions are now available via API
curl -X POST http://localhost:8000/api/v1/code/get-question \
  -H "Content-Type: application/json" \
  -d '{"mode":"code","user_id":"user123","difficulty":"medium"}'
```

### 3. Check Question Availability
```bash
curl http://localhost:8000/api/v1/questions/stats
```

## Migration Notes

### For Existing Users

1. **Database Connection**: code-sandbox now connects to `qa_gen_db` instead of `sandbox_db`
2. **Question Generation**: Use qa_gen_spice service to generate questions before using code-sandbox
3. **API Endpoints**: Update client code to use new endpoints:
   - `/code/generate-question` → `/code/get-question`
   - `/aptitude/generate-question` → `/aptitude/get-question`

### Data Migration

If you have existing questions in `sandbox_db`:

```python
# Migration script (example)
from pymongo import MongoClient

client = MongoClient("mongodb://...")
old_db = client["sandbox_db"]
new_db = client["qa_gen_db"]

# Migrate code questions
for q in old_db.code_questions.find():
    q["question_type"] = "code"
    new_db.dsa_questions.insert_one(q)

# Migrate aptitude questions
for q in old_db.aptitude_questions.find():
    q["question_type"] = "apti"
    new_db.dsa_questions.insert_one(q)
```

## Error Handling

### No Questions Available

If no questions match the criteria, the API returns:

```json
{
  "status_code": 404,
  "detail": "No questions available matching the criteria. Please generate questions using qa_gen_spice service first."
}
```

**Resolution:**
1. Check question availability: `GET /api/v1/questions/stats`
2. Generate questions using qa_gen_spice
3. Retry the request

## Benefits

1. **Separation of Concerns**: Question generation and execution are separate services
2. **Performance**: Pre-generated questions load faster
3. **Quality Control**: Questions can be reviewed before use
4. **Consistency**: Same question pool across all users
5. **Scalability**: Questions generated in batch, served on demand

## Testing

### Test Question Retrieval

```bash
# Check available questions
curl http://localhost:8000/api/v1/questions/stats

# Fetch a code question
curl -X POST http://localhost:8000/api/v1/code/get-question \
  -H "Content-Type: application/json" \
  -d '{
    "mode": "code",
    "user_id": "test_user",
    "difficulty": "easy"
  }'

# Fetch an aptitude question
curl -X POST http://localhost:8000/api/v1/aptitude/get-question \
  -H "Content-Type: application/json" \
  -d '{
    "mode": "apti",
    "user_id": "test_user",
    "difficulty": "medium"
  }'
```

## Future Enhancements

1. **Question Pooling**: Prevent same question from appearing too frequently
2. **User History**: Track which questions user has seen
3. **Adaptive Difficulty**: Adjust question difficulty based on performance
4. **Question Feedback**: Allow users to rate questions
5. **Bulk Generation**: API endpoint to trigger question generation
6. **Caching**: Cache frequently accessed questions

## Support

For issues related to:
- **Question Generation**: Check qa_gen_spice service
- **Question Retrieval**: Check code-sandbox service
- **Database Connection**: Verify MongoDB connectivity and credentials
